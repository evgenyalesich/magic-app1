# bot/main.py
import os
import sys
import asyncio
import logging

from aiogram import Bot, Dispatcher, types, F
from aiogram.client.default import DefaultBotProperties
from aiogram.types import WebAppInfo
from aiogram.utils.keyboard import InlineKeyboardBuilder
from dotenv import load_dotenv
import httpx

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[logging.StreamHandler(sys.stdout)],
)
log = logging.getLogger(__name__)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑÑ€ĞµĞ´Ñ‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
API_BASE = os.getenv(
    "BACKEND_API_BASE"
)  # Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ https://ideas-destination-modify-justin.trycloudflare.com
FRONTEND_ORIGIN = os.getenv("FRONTEND_ORIGIN", API_BASE)

if not TOKEN:
    raise RuntimeError("âš ï¸  TELEGRAM_BOT_TOKEN Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² .env")
if not API_BASE:
    raise RuntimeError("âš ï¸  BACKEND_API_BASE Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² .env")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  aiogram  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
default_props = DefaultBotProperties(parse_mode="HTML")
bot = Bot(TOKEN, default=default_props)  # â† Ğ±ĞµĞ· parse_mode!
dp = Dispatcher()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  /start  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message(F.text == "/start")
async def start_handler(msg: types.Message) -> None:
    tg_id = msg.from_user.id
    tg_name = msg.from_user.username or msg.from_user.first_name
    log.info("ğŸ¤– /start from %s (%s)", tg_id, tg_name)

    async with httpx.AsyncClient(base_url=API_BASE, timeout=10) as client:

        # 1) bot-register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            r = await client.post(
                "/api/auth/bot-register",
                json={"telegram_id": tg_id, "username": tg_name},
            )
            log.info("â¡ï¸  bot-register %s", r.status_code)
            r.raise_for_status()
            log.info("âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ %s Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½", tg_name)
        except httpx.HTTPError as e:
            log.error("ğŸ›‘ bot-register failed: %s", e)
            await msg.answer("ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ ğŸ˜” ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ")
            return

        # 2) login (Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            login_resp = await client.post(
                "/api/auth/login", json={"telegram_id": tg_id, "username": tg_name}
            )
            log.info("â¡ï¸  login %s", login_resp.status_code)
            log.debug("  â†³ %s", login_resp.json())
            login_resp.raise_for_status()
        except httpx.HTTPError as e:
            log.error("ğŸ›‘ login failed: %s", e)
        # 3) me (Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            # /me Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ cookie, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ½ĞµĞ¼ tg_id ĞºĞ°Ğº query-string,
            # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞµÑ€Ğ²ĞµÑ€ Ğ½Ğ°ÑˆÑ‘Ğ» Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
            me_resp = await client.get("/api/auth/me", params={"tg_id": tg_id})
            log.info("â¡ï¸  me %s", me_resp.status_code)
            log.debug("  â†³ %s", me_resp.json() if me_resp.is_success else me_resp.text)
        except httpx.HTTPError as e:
            log.error("ğŸ›‘ me failed: %s", e)

    # 4) ĞºĞ½Ğ¾Ğ¿ĞºĞ° Web-App  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    kb = InlineKeyboardBuilder()
    kb.button(
        text="ğŸ”® Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Ğ²Ğ¾Ğ»ÑˆĞµĞ±Ğ½Ñ‹Ğ¹ Ğ¼Ğ¸Ñ€",
        web_app=WebAppInfo(url=FRONTEND_ORIGIN),
    )
    log.info("ğŸ”— Web-app URL: %s", FRONTEND_ORIGIN)

    await msg.answer(
        "âœ¨ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ.",
        reply_markup=kb.as_markup(),
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Ğ·Ğ°Ğ¿ÑƒÑĞº  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main() -> None:
    await dp.start_polling(bot)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        log.info("ğŸ›‘ Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
